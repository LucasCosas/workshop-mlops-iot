{"source":2,"revision":3,"description":null,"createdBy":{"displayName":"Lucas.Cosas@microsoft.com","url":"https://spsprodsbr1.vssps.visualstudio.com/A29442670-0073-4cbd-a035-9a75aa76ace9/_apis/Identities/cf70984a-7d91-6769-a0e6-de0b855d0176","_links":{"avatar":{"href":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"}},"id":"cf70984a-7d91-6769-a0e6-de0b855d0176","uniqueName":"Lucas.Cosas@microsoft.com","imageUrl":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2","descriptor":"aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"},"createdOn":"2020-09-29T14:56:06.260Z","modifiedBy":{"displayName":"Lucas.Cosas@microsoft.com","url":"https://spsprodsbr1.vssps.visualstudio.com/A29442670-0073-4cbd-a035-9a75aa76ace9/_apis/Identities/cf70984a-7d91-6769-a0e6-de0b855d0176","_links":{"avatar":{"href":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"}},"id":"cf70984a-7d91-6769-a0e6-de0b855d0176","uniqueName":"Lucas.Cosas@microsoft.com","imageUrl":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2","descriptor":"aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"},"modifiedOn":"2020-09-29T15:05:00.880Z","isDeleted":false,"variables":{"ENDPOINT_NAME_PROD":{"value":""},"ENDPOINT_NAME_QA":{"value":""},"MODEL_NAME_PROD":{"value":""},"MODEL_NAME_QA":{"value":""},"RESOURCE_GROUP_PROD":{"value":""},"RESOURCE_GROUP_QA":{"value":""},"WORKING_DIR_PROD":{"value":"_REPOSITORY/config/"},"WORKING_DIR_QA":{"value":"_REPOSITORY/config/"},"WORKSPACE_PROD":{"value":""},"WORKSPACE_QA":{"value":""}},"variableGroups":[],"environments":[{"id":2,"name":"QA - Deploy to ACI","rank":1,"owner":{"displayName":"Lucas.Cosas@microsoft.com","url":"https://spsprodsbr1.vssps.visualstudio.com/A29442670-0073-4cbd-a035-9a75aa76ace9/_apis/Identities/cf70984a-7d91-6769-a0e6-de0b855d0176","_links":{"avatar":{"href":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"}},"id":"cf70984a-7d91-6769-a0e6-de0b855d0176","uniqueName":"Lucas.Cosas@microsoft.com","imageUrl":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2","descriptor":"aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":4}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":7},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Lucas.Cosas@microsoft.com","url":"https://spsprodsbr1.vssps.visualstudio.com/A29442670-0073-4cbd-a035-9a75aa76ace9/_apis/Identities/cf70984a-7d91-6769-a0e6-de0b855d0176","_links":{"avatar":{"href":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"}},"id":"cf70984a-7d91-6769-a0e6-de0b855d0176","uniqueName":"Lucas.Cosas@microsoft.com","imageUrl":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2","descriptor":"aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"},"id":8}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-20.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":9,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"install prereqs","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az extension add -n azure-cli-ml","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Deploy Model to QA","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"cd $(System.DefaultWorkingDirectory)/$WORKING_DIR_QA\n         \n\n\n         MODEL_VERSION=$(az ml model list -n $MODEL_NAME_QA -g $RESOURCE_GROUP_QA -w $WORKSPACE_QA --query '[0].version')\n         echo \"Model version to be deployed: \" $MODEL_VERSION\n         \n         az ml model deploy -g $RESOURCE_GROUP_QA -w $WORKSPACE_QA -n $ENDPOINT_NAME_QA --model $MODEL_NAME_QA:$MODEL_VERSION --ic inferenceconfig.json --dc deploymentconfigaci.json --overwrite\n         \n         echo \"Deploying model: \" $MODEL_NAME_QA \" in Workspace:\" $WORKSPACE_QA\n","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Check endpoint state","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"#### Loop to check the endpoint state\n         MAX_ATTEMPT=10\n         \n         for attempt in {1..$MAX_ATTEMPT}\n             do\n             echo \"(attempt: $attempt) Checking endpoint state\"\n         \n             CURRENT_STATE=$(az ml endpoint realtime show --name $ENDPOINT_NAME_QA  --resource-group $RESOURCE_GROUP_QA --workspace-name $WORKSPACE_QA -v --query 'state')\n             # Remove quotes\n             CURRENT_STATE=${CURRENT_STATE//'\"'}\n             echo $CURRENT_STATE\n         \n             if [ \"$CURRENT_STATE\" = \"Healthy\" ]; then\n                 echo \"Finishing in state: $CURRENT_STATE\"\n                 exit 0 # Success\n             fi\n         \n             sleep 10\n             done\n         \n         echo \"Finishing in state: $CURRENT_STATE\"\n         exit 1 # Fail","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/LucasCosas/76129c71-5e12-4360-8cec-ca81af0d2bda/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/LucasCosas/_apis/public/Release/badge/76129c71-5e12-4360-8cec-ca81af0d2bda/2/2"},{"id":3,"name":"PROD - Deploy to AKS","rank":2,"owner":{"displayName":"Lucas.Cosas@microsoft.com","url":"https://spsprodsbr1.vssps.visualstudio.com/A29442670-0073-4cbd-a035-9a75aa76ace9/_apis/Identities/cf70984a-7d91-6769-a0e6-de0b855d0176","_links":{"avatar":{"href":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"}},"id":"cf70984a-7d91-6769-a0e6-de0b855d0176","uniqueName":"Lucas.Cosas@microsoft.com","imageUrl":"https://dev.azure.com/LucasCosas/_apis/GraphProfile/MemberAvatars/aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2","descriptor":"aad.Y2Y3MDk4NGEtN2Q5MS03NzY5LWEwZTYtZGUwYjg1NWQwMTc2"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":5}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":6},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":9}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-20.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":9,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Install prereqs","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az extension add -n azure-cli-ml","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Download model from QA","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"MODEL_VERSION=$(az ml model list -n $MODEL_NAME_QA -g $RESOURCE_GROUP_QA -w $WORKSPACE_QA --query '[0].version')\n\n\n\naz ml model download -w $WORKSPACE_QA -g $RESOURCE_GROUP_QA -i $MODEL_NAME_QA:$MODEL_VERSION -v -t /home/vsts/work/model\n\necho \"Realizado Download do modelo: \" $MODEL_NAME_QA \" do Workspace:\" $WORKSPACE_QA","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Register model to PROD","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az ml model register -n $MODEL_NAME_PROD -p /home/vsts/work/model/model_folder/model.pkl -w $WORKSPACE_PROD -g $RESOURCE_GROUP_PROD\n \necho \"Realizado Registro do modelo: \" $MODEL_NAME_PROD \" do Workspace:\" $WORKSPACE_PROD","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Deploy model to PROD","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"cd $(System.DefaultWorkingDirectory)/$WORKING_DIR_PROD\n\nMODEL_VERSION=$(az ml model list -n $MODEL_NAME_PROD -g $RESOURCE_GROUP_PROD -w $WORKSPACE_PROD --query '[0].version')\n\naz ml model deploy -g $RESOURCE_GROUP_PROD -w $WORKSPACE_PROD -n $ENDPOINT_NAME_PROD --model $MODEL_NAME_PROD:$MODEL_VERSION --ic inferenceconfigprod.json --dc aksDeploymentConfig.yml  --compute-target aks-credit  --overwrite\n\necho \"Realizado Deploy do modelo: \" $MODEL_NAME_PROD \" do Workspace:\" $WORKSPACE_PROD \" para o endpoint: \" $ENDPOINT_NAME_PROD","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"Check endpoint state","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"41ac02a2-705e-46f3-a1c1-44281f5f8103","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"steps:\n    - task: AzureCLI@2\n      displayName: 'Check endpoint state'\n      inputs:\n        azureSubscription: '<YOUR_SUBSCRIPTION>'\n        scriptType: bash\n        scriptLocation: inlineScript\n        inlineScript: |\n         #### Loop to check the endpoint state\n         MAX_ATTEMPT=10\n         \n         for attempt in {1..$MAX_ATTEMPT}\n             do\n             echo \"(attempt: $attempt) Checking endpoint state\"\n         \n             CURRENT_STATE=$(az ml endpoint realtime show --name $ENDPOINT_NAME_QA  --resource-group $RESOURCE_GROUP_QA --workspace-name $WORKSPACE_QA -v --query 'state')\n             # Remove quotes\n             CURRENT_STATE=${CURRENT_STATE//'\"'}\n             echo $CURRENT_STATE\n         \n             if [ \"$CURRENT_STATE\" = \"Healthy\" ]; then\n                 echo \"Finishing in state: $CURRENT_STATE\"\n                 exit 0 # Success\n             fi\n         \n             sleep 10\n             done\n         \n         echo \"Finishing in state: $CURRENT_STATE\"\n         exit 1 # Fail","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"QA - Deploy to ACI","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/LucasCosas/76129c71-5e12-4360-8cec-ca81af0d2bda/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/LucasCosas/_apis/public/Release/badge/76129c71-5e12-4360-8cec-ca81af0d2bda/2/3"}],"artifacts":[],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseImport"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":2,"name":"CD Pipeline - Copy","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/LucasCosas/76129c71-5e12-4360-8cec-ca81af0d2bda/_apis/Release/definitions/2","_links":{"self":{"href":"https://vsrm.dev.azure.com/LucasCosas/76129c71-5e12-4360-8cec-ca81af0d2bda/_apis/Release/definitions/2"},"web":{"href":"https://dev.azure.com/LucasCosas/76129c71-5e12-4360-8cec-ca81af0d2bda/_release?definitionId=2"}}}